<!DOCTYPE html>
<meta charset="utf-8">
<style>

 .root {}

 .panel {
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   bottom: 0;
 }

 .select {
   background-color: grey;
 }

 .border {
   border: 1px solid;
 }

 .chartModalDialog {
   position: fixed;
   top: 0;
   right: 0;
   bottom: 0;
   left: 0;
   background: lightGrey;
   z-index: 99999;
   opacity:0;
   pointer-events: none;
 }

 .activeModal {
   opacity:0.9;
   pointer-events: auto;
   width: 400px;
   position: relative;
   margin: 5% auto;
   padding: 5px 20px 13px 20px;
   border-radius: 5px;
   background: lightGrey;
   border: 1px solid
 }

</style>
<body>
  <div id="chartModal" dragable="true" class="chartModalDialog">
    <div>
      <select id="chartselection"></select>
      <button id="addChart">Add</button>
      <button id="clearChart">Clear</button>
      <button id="closeModal">Close</button>
    </div>
  </div>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="./chart.js"></script>
<script>
var id = 0;
function genid() { return 'p' + id++  };

var data = [{children: [{children: [], parent: undefined, is_leaf: true, id: genid() }]}];
function root() { return data[0].children[0]; }

var clicked_child = root();
var charts = { rect: Chart};
var active_charts = {}
var step = 5; // Resize step, % of screen space.

//
// Build up tree
//

readd();
function readd() {
    d3.select('.root').remove();
    var root = d3.select('body')
        .selectAll('.panel')
        .data(data, function(d) {
            return d.id;
        })

    root.enter()
        .append('div')
        .attr('class', 'root panel')

    readd0(root);
    resize_chart();
}

function readd0(node) {

    if(node[0] == null) {
        return;
    }

    var new_node = node.selectAll('.panel')
        .data(function(d){
            return d.children;
        }, function(d) {
            return d.id;
        });

    new_node.enter()
        .append('div')
        .attr('id', function(d) {
            return d.id;
        })
        .classed('panel',true)
        .classed('border', function(d) {
            return d.is_leaf;
        })
        .classed('select', function(d) {
            return d.is_active;
        }),

    new_node.classed('border', function(d) {
        return d.is_leaf;
    })
        .classed('select', function(d) {
            return d.is_active;
        });

    new_node.each(function(d) {
        var v = d.size + '%';
        d3.select(this)
            .style(d.side,v);

        if(d.id in active_charts) {
            active_charts[d.id].create(d.id);
        }
    });

    new_node.on('click', select);
    new_node.on('dblclick', parentselect);

    readd0(new_node);
}

//
// Modify panels
//

function resize_panel() {
    d3.select('#'+clicked_child.parent.id)
        .selectAll('.panel')
        .each(function(d) {
            var v = d.size + '%';
            d3.select(this)
                .style(d.side,v);
        })
            }

function resize_node(c0,c1) {
    if(c0.size - step > 0 && c1.size + step < 100) {
        c0.size -= step;
        c1.size += step;
    }
}

function remove_node(c) {
    var p = c.parent;
    if(c.is_leaf && p.parent) {
        var o = p.children[c.idx^1]
        if(o.children != 0 && p.parent) {
            var pp = p.parent;
            pp.children[p.idx] = o;
            o.side = p.side;
            o.size = p.size;
            o.idx = p.idx;
            o.parent = pp;
        } else {
            p.children = [];
            p.is_leaf = true;
            p.is_active = false;
            p.id = o.id;
        }
    }
}

function split_node(pos) {
    // Only split children.
    if(!clicked_child.is_leaf) return;

    clicked_child.is_leaf = false;
    clicked_child.is_active = false;
    var side0 = pos == 'h' ? 'top' : 'left';
    var side1 = pos == 'h' ? 'bottom' : 'right';
    d3.select('#c' + clicked_child.id).remove();

    function newchild(idx, side, active) {
        return {children: [], parent: clicked_child, pos: pos,
                is_leaf: true, size: 50, side: side,
                is_active: active,  idx: idx, id: genid()
               };
    }
    var child0 = newchild(0, side0, true);

    if(clicked_child.id in active_charts) {
        var chart = active_charts[clicked_child.id];
        active_charts[child0.id] = chart;
        delete active_charts[clicked_child.id];
    }

    var child1 = newchild(1, side1, false);
    clicked_child.children.push(child0);
    clicked_child.children.push(child1);

    if(child0.id in active_charts) {
        active_charts[child0.id].create(child0.id);
    }
    clicked_child = child0;
}

//
// Events
//

d3.select('body').on('keypress', function() {
    var code = d3.event.keyCode;
    if(code == 118) { // v
        split_node('v');
        readd();
    } else if (code == 104) { // h
        split_node('h');
        readd();
    } else if (code == 119) { // w
        var p = clicked_child.parent;
        if(!p) return;
        var cs = p.children;
        resize_node(cs[0],cs[1]);
        resize_panel();
        resize_chart()
    } else if (code == 115) { // s
        var p = clicked_child.parent;
        if(!p) return;
        var cs = p.children;
        resize_node(cs[1],cs[0]);
        resize_panel();
        resize_chart();
    } else if(code == 114) { // r
        if(clicked_child.is_leaf) {
            remove_node(clicked_child);
            d3.select('#'+clicked_child.id).remove();
            readd();
        }
    } else if(code == 99) { // c
        if(clicked_child.is_leaf){
            d3.select('#chartModal')
                .classed('activeModal', true)
        }
    }
})

d3.select(window).on('resize', function(){
    resize_chart();
})

function parentselect(d) {
    if(!d.is_leaf) return;
    clicked_child.is_active = false;
    if(d.parent) {
        clicked_child = d.parent;
        clicked_child.is_active = true;
    }
    mark_selected();
}

function select(n){
    if(!n.is_leaf) return;
    clicked_child.is_active = false;
    clicked_child = n;
    clicked_child.is_active = true;
    mark_selected();
}

function mark_selected() {
    d3.selectAll('.panel')
        .classed('select', function(d) {
            return d.is_active;
        })
}

function resize_chart() {
    d3.selectAll('.panel')
        .each(function(d) {
            if(d.id in active_charts) {
                var p = d3.select(this);
                var w = parseInt(p.style('width'));
                var h = parseInt(p.style('height'));
                active_charts[d.id].resize(w,h);
            }
        })
            }

//
// Modal to add charts to leafnodes
//

d3.select('#chartselection')
    .selectAll('alternatives')
    .data(d3.map(charts).keys())
    .enter()
    .append('option')
    .attr('value', function(d) {
        return d;
    }).text(function(d) {
        return d;
    })

d3.select('#addChart')
    .on('click', function(){
        if(!(clicked_child.id in active_charts)){
            var name = d3.select('#chartselection').text();
            active_charts[clicked_child.id] = new charts[name](clicked_child.id);
            resize_chart();
        }
    });

d3.select('#clearChart')
    .on('click', function(){
        if(clicked_child.id in active_charts){
            d3.select('#c'+clicked_child.id).remove();
            delete active_charts[clicked_child.id];
        }
    })

d3.select('#closeModal')
    .on('click', function(){
        d3.select('#chartModal')
            .classed('activeModal', false)
    })
</script>
